// Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_URL")
}

enum Theme {
  light
  dark
  system
}

enum AvatarMode {
  default
  gravatar
}

enum SubscriptionTier {
  growth
  professional
  enterprise
}

enum DashboardRole {
  owner
  admin
  editor
  viewer
}

enum InvitationStatus {
  pending
  accepted
  declined
  cancelled
  expired
}

enum UserRole {
  admin
  user
}

enum Currency {
  USD
  EUR
}

model Account {
  id                 String    @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  expires      DateTime
  sessionToken String   @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  accounts      Account[]
  sessions      Session[]

  passwordHash String?
  totpEnabled Boolean @default(false)
  totpSecret String?
  role UserRole?

  termsAcceptedVersion Int?
  termsAcceptedAt      DateTime?
  changelogVersionSeen String? @default("v0")

  onboardingCompletedAt DateTime?

  dashboardAccess UserDashboard[]
  settings UserSettings?
  subscription Subscription?
  passwordResetTokens PasswordResetToken[]
  bugReports BugReport[]
  annotations Annotation[]
  sentInvitations DashboardInvitation[]
}

model VerificationToken {
  id         String   @id @default(cuid())
  identifier String
  token      String   @unique
  expires    DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, token])
}

model UserSettings {
  id String @id @default(cuid())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique

  // Theme preferences
  theme Theme @default(system) // "light", "dark", "system"
  language String @default("en") // ISO language codes
  avatar AvatarMode @default(default) // "default", "gravatar"

  // Email preferences
  emailNotifications Boolean @default(true) // Sign up, login, password reset, reminders, alerts etc.
  marketingEmails Boolean @default(false) // Product updates, features, tips

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Dashboard {
  id String @id @default(cuid())
  siteId String @unique
  domain String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  userAccess UserDashboard[]
  funnels Funnel[]
  savedFilters SavedFilter[]
  settings DashboardSettings?
  config SiteConfig?
  bugReports BugReport[]
  annotations Annotation[]
  monitorChecks MonitorCheck[]
  invitations DashboardInvitation[]
  emailReportHistory EmailReportHistory[]
  integrations DashboardIntegration[]
}

model UserDashboard {
  id String @id @default(cuid())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  dashboard Dashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  dashboardId String

  role DashboardRole @default(viewer)

  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, dashboardId])
}

model Funnel {
  id String @id @default(cuid())

  name     String
  isStrict Boolean @default(true)

  funnelSteps FunnelStep[]

  dashboard    Dashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  dashboardId  String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt @default(now())

  deletedAt DateTime?
}

model FunnelStep {
  id String @id @default(cuid())

  name String
  column String
  operator String
  values String[]

  funnel Funnel @relation(fields: [funnelId], references: [id], onDelete: Cascade)
  funnelId String

  @@index([funnelId])
}

model SavedFilter {
  id String @id @default(cuid())

  name String @db.VarChar(64)

  entries SavedFilterEntry[]

  dashboard   Dashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  dashboardId String

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([dashboardId])
}

model SavedFilterEntry {
  id String @id @default(cuid())

  column   String
  operator String
  values   String[]

  savedFilter   SavedFilter @relation(fields: [savedFilterId], references: [id], onDelete: Cascade)
  savedFilterId String

  @@index([savedFilterId])
}

model DashboardSettings {
  id String @id @default(cuid())

  dashboard Dashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  dashboardId String @unique

  // Display Settings
  showGridLines Boolean @default(true)
  defaultDateRange String @default("7d") // 24h, 7d, 28d, 3mo

  // Data Settings
  dataRetentionDays Int @default(365) // Number of days to retain data

  // Report Settings
  weeklyReports Boolean @default(false)
  weeklyReportDay Int @default(1) // ISO: 1=Monday, 2=Tuesday, ... 7=Sunday
  weeklyReportRecipients String[] @default([])
  monthlyReports Boolean @default(false)
  monthlyReportRecipients String[] @default([])
  lastWeeklyReportSentAt DateTime?
  lastMonthlyReportSentAt DateTime?

  // Alert Settings
  alertsEnabled Boolean @default(false)
  alertsThreshold Int @default(1000) // Threshold for traffic alerts

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EmailReportHistory {
  id          String   @id @default(cuid())

  dashboard   Dashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  dashboardId String

  reportType  String   // 'weekly' | 'monthly'
  recipient   String
  status      String   // 'sent' | 'failed'

  periodStart DateTime
  periodEnd   DateTime

  sentAt       DateTime @default(now())
  errorMessage String?

  @@index([dashboardId, sentAt])
}

model SiteConfig {
  id        String   @id @default(cuid())
  dashboard Dashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  dashboardId String @unique

  blacklistedIps String[] @default([])
  enforceDomain Boolean @default(false)

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}


model MonitorCheck {
  id                    String    @id @default(cuid())
  dashboard             Dashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  dashboardId           String
  name                  String?
  url                   String
  intervalSeconds       Int       @default(30)
  timeoutMs             Int       @default(3000)
  isEnabled             Boolean   @default(true)
  checkSslErrors        Boolean   @default(true)
  sslExpiryReminders    Boolean   @default(true)
  httpMethod            String    @default("HEAD")
  requestHeaders        Json?
  acceptedStatusCodes   Json      @default("[\"2xx\"]")
  expectedKeyword       String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Alert configuration
  alertsEnabled         Boolean   @default(true)
  alertEmails           String[]  @default([])  // Email addresses to notify for alerts
  alertOnDown           Boolean   @default(true)
  alertOnRecovery       Boolean   @default(true)
  alertOnSslExpiry      Boolean   @default(true)
  sslExpiryAlertDays    Int       @default(14)  // Days before expiry to alert
  failureThreshold      Int       @default(3)   // Consecutive failures before alerting

  deletedAt             DateTime?

  @@index([dashboardId])
  @@unique([id, dashboardId])
}

model Subscription {
  id String @id @default(cuid())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique
  
  // Plan configuration
  tier SubscriptionTier // "growth", "professional", "enterprise"
  eventLimit Int // Selected event limit: 10_000, 50_000, 100_000, etc.
  pricePerMonth Int // Price in cents
  currency Currency @default(USD)

  // Billing cycle
  currentPeriodStart DateTime
  currentPeriodEnd DateTime

  // Quota tracking
  quotaExceededDate DateTime?

  // Subscription status
  status String @default("active") // "active", "canceled"
  cancelAtPeriodEnd Boolean @default(false)

  // Payment provider integration
  paymentCustomerId String?
  paymentSubscriptionId String?
  paymentPriceId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, status])
  @@index([currentPeriodStart, currentPeriodEnd])
}

model BugReport {
  id String @id @default(cuid())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  dashboard Dashboard? @relation(fields: [dashboardId], references: [id], onDelete: SetNull)
  dashboardId String?

  message String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dashboardId])
  @@index([userId])
}

model Annotation {
  id String @id @default(cuid())

  dashboard Dashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  dashboardId String

  // Chart identifier (e.g., "overview", "web-vitals", "page-traffic", etc.)
  chartId String

  date DateTime
  label String @db.VarChar(48)
  description String? @db.VarChar(256)

  colorToken String?

  createdBy User @relation(fields: [createdById], references: [id], onDelete: Cascade)
  createdById String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  @@index([dashboardId, chartId])
  @@index([dashboardId, date])
  @@index([createdById])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  expires   DateTime
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
}

model DashboardInvitation {
  id          String   @id @default(cuid())
  
  dashboard   Dashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  dashboardId String
  
  email       String
  role        DashboardRole @default(viewer)
  
  invitedBy   User     @relation(fields: [invitedById], references: [id], onDelete: Cascade)
  invitedById String
  
  token       String   @unique @default(cuid())
  expiresAt   DateTime
  status      InvitationStatus @default(pending)
  
  createdAt   DateTime @default(now())
  
  @@index([dashboardId, email])
  @@index([email])
  @@index([token])
  @@index([status])
}

model DashboardIntegration {
  id          String    @id @default(cuid())
  dashboard   Dashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  dashboardId String
  type        String    // "pushover", "slack", "discord", etc.
  name        String?
  enabled     Boolean   @default(true)
  config      Json      // Type-specific config (e.g. { userKey, apiToken } for Pushover)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([dashboardId, type])
  @@index([dashboardId])
}